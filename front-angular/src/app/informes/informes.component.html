<div class="title-container">
  <div class="title-item">
    <h1>Informes</h1>
  </div>
</div>

<div class="content-container">
  <div class="main-content">

    <div class="form-container">
      <div class="div-mat-reporte">
        <div class="div-mat-option-reporte">
          <mat-form-field appearance="outline" class="input-medium"> 
            <mat-label class="mat-label">Reporte:</mat-label>
            <mat-select
              [(ngModel)]="reporteSeleccionado"
              name="reporte" 
              placeholder="Seleccionar Reporte" 
              (selectionChange)="onReporteSeleccionado()">
              
              <mat-option *ngFor="let reporte of reportes" [value]="reporte.nombre">
                {{ reporte.nombre }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Seleccion Informe Mensual Empleado -->
        <div *ngIf="reporteSeleccionado === 'Informe mensual empleado'" class="div-reporte-fecha-dia">

          <mat-form-field appearance="outline" class="input-medium" style="margin-right: 0.5em;">
            <mat-label class="mat-label">Mes:</mat-label>
            <mat-select id="mesSelect" [(ngModel)]="mesSeleccionado" name="mesSelect">
              <mat-option value="" disabled selected>Seleccionar Mes</mat-option>
              <mat-option *ngFor="let mes of meses" [value]="mes">{{ mes }}</mat-option>
            </mat-select>
          </mat-form-field>
        
          <mat-form-field appearance="outline" class="input-medium">
            <mat-label class="mat-label">Año:</mat-label>
            <mat-select id="anioSelect" [(ngModel)]="anioSeleccionado" name="anioSelect">
               <mat-option value="" disabled selected>Seleccionar Año</mat-option>
              <mat-option *ngFor="let anio of anios" [value]="anio">{{ anio }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="input-medium" style="margin-left: 0.5em;">
            <mat-label class="mat-label">Buscar Empleado</mat-label>
            <input
              type="text"
              matInput
              [formControl]="empleadoControl"
              [matAutocomplete]="autoEmpleado"
            />
            <mat-autocomplete #autoEmpleado="matAutocomplete" (optionSelected)="seleccionarEmpleado($event.option.value)" [displayWith]="displayEmployeeName">
              <mat-option *ngFor="let empleado of empleadosFiltrados" [value]="empleado">
                {{ empleado.apellido }} {{ empleado.nombre }}
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>
        </div>
        
        <!-- Seleccion Reporte Resumen por Empresa -->
        <div *ngIf="reporteSeleccionado === 'Resumen por Empresa'" class="div-reporte-mes-anio">
          <mat-form-field appearance="outline" class="input-medium" style="margin-right: 0.5em;">
            <mat-label class="mat-label">Mes:</mat-label>
            <mat-select id="mesSelect" [(ngModel)]="mesSeleccionado" name="mesSelect">
              <mat-option value="" disabled selected>Seleccionar Mes</mat-option>
              <mat-option *ngFor="let mes of meses" [value]="mes">{{ mes }}</mat-option>
            </mat-select>
          </mat-form-field>
        
          <mat-form-field appearance="outline" class="input-medium">
            <mat-label class="mat-label">Año:</mat-label>
            <mat-select id="anioSelect" [(ngModel)]="anioSeleccionado" name="anioSelect">
               <mat-option value="" disabled selected>Seleccionar Año</mat-option>
              <mat-option *ngFor="let anio of anios" [value]="anio">{{ anio }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Seleccion Reporte de horas por Dia -->
        <div *ngIf="reporteSeleccionado === 'Reporte de horas por Dia'" class="div-reporte-fecha-dia">

          <mat-form-field appearance="outline" class="input-medium" style="margin-right: 0.5em;">
            <mat-label class="mat-label">Fecha Inicio</mat-label>
            <input matInput [matDatepicker]="pickerInicio" [(ngModel)]="fechaInicio" id="fechaInicio" />
            <mat-datepicker-toggle matIconSuffix [for]="pickerInicio"></mat-datepicker-toggle>
            <mat-datepicker #pickerInicio></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline" class="input-medium" style="margin-right: 0.5em;">
            <mat-label class="mat-label">Fecha Fin</mat-label>
            <input matInput [matDatepicker]="pickerFin" [(ngModel)]="fechaFin" id="fechaFin" />
            <mat-datepicker-toggle matIconSuffix [for]="pickerFin"></mat-datepicker-toggle>
            <mat-datepicker #pickerFin></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline" class="input-medium" style="margin-right: 0.5em;">
            <mat-label class="mat-label">Buscar Empleado</mat-label>
            <input
              type="text"
              matInput
              [formControl]="empleadoControl"
              [matAutocomplete]="autoEmpleado"
            />
            <mat-autocomplete #autoEmpleado="matAutocomplete" (optionSelected)="seleccionarEmpleado($event.option.value)" [displayWith]="displayEmployeeName">
              <mat-option *ngFor="let empleado of empleadosFiltrados" [value]="empleado">
                {{ empleado.apellido }} {{ empleado.nombre }}
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>

          <mat-form-field appearance="outline" class="input-medium">
            <mat-label class="mat-label">Buscar Servicios</mat-label>
            <input
              type="text"
              matInput
              [formControl]="empresaControl"
              [matAutocomplete]="autoServicio"
            />
            <mat-autocomplete #autoServicio="matAutocomplete" (optionSelected)="seleccionarEmpresa($event.option.value)" [displayWith]="displayEmpresaName">
              <mat-option *ngFor="let empresa of empresasFiltradas" [value]="empresa">
                {{ empresa.nombre }}
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>
        </div>

      </div>

      <div *ngIf="reporteSeleccionado" class="form-row-footer">
        <div class="form-group">
            <button mat-flat-button class="btn-generar" color="primary" (click)="ejecutarReporte()" >Generar</button>
        </div>
        <div class="group-right">
          <div class="form-group-footer" *ngIf="reporteSeleccionado !== 'Informe mensual empleado'">
              <button mat-raised-button color="primary" (click)="descargarPdf()">
              <mat-icon>get_app</mat-icon> PDF
              </button>
          </div>
          <div class="form-group-footer" *ngIf="reporteSeleccionado == 'Informe mensual empleado'">
              <button mat-raised-button color="primary" (click)="descargarPdfEmpleado()">
              <mat-icon>get_app</mat-icon> PDF
              </button>
          </div>
          <div class="form-group-footer"  *ngIf="reporteSeleccionado !== 'Informe mensual empleado'">
              <button mat-raised-button color="primary" (click)="descargarExcel()">
              <mat-icon>get_app</mat-icon> Excel
              </button>
          </div>
          <div class="form-group-footer"  *ngIf="reporteSeleccionado == 'Informe mensual empleado'">
              <button mat-raised-button color="primary" (click)="descargarExcelEmpleado()">
              <mat-icon>get_app</mat-icon> Excel
              </button>
          </div>
        </div>
      </div>        

    <!-- Tabla Resumen por empresa -->
    <div *ngIf="reporteSeleccionado === 'Resumen por Empresa'">
      <div class="table-container mat-elevation-z8"> 
        <table mat-table [dataSource]="dataSource" matSort> 
          <ng-container matColumnDef="empresa">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Empresa </th>
            <td mat-cell *matCellDef="let orden"> {{ orden.nombreServicio }} </td>
          </ng-container>

          <ng-container matColumnDef="horarioAsignado">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Horario Asignado </th>
            <td mat-cell *matCellDef="let orden"> {{ orden.horario }}</td>
          </ng-container>
  
          <ng-container matColumnDef="dias">
            <th mat-header-cell *matHeaderCellDef> Dias </th>
            <td mat-cell *matCellDef="let orden"> {{ orden.dias }} </td>
          </ng-container>

          <ng-container matColumnDef="horasAutorizadas">
            <th mat-header-cell *matHeaderCellDef> Horas Autorizadas </th>
            <td mat-cell *matCellDef="let orden"> {{ orden.horasAutorizadas }} </td> 
          </ng-container> 

          <ng-container matColumnDef="horasProyectadas">
            <th mat-header-cell *matHeaderCellDef> Horas Proyectadas </th>
            <td mat-cell *matCellDef="let orden"> {{ orden.horasProyectadas }} </td> 
          </ng-container> 
  
          <ng-container matColumnDef="horasTrabajadas">
            <th mat-header-cell *matHeaderCellDef> Horas Trabajadas </th>
            <td mat-cell *matCellDef="let orden"> {{ orden.horasTrabajadas }} </td> 
          </ng-container> 

          <ng-container matColumnDef="horasAusentismoPago">
            <th mat-header-cell *matHeaderCellDef> Horas Ausentismo Pago </th>
            <td mat-cell *matCellDef="let orden"> {{ orden.horasAusentismoPago }} </td> 
          </ng-container> 

          <ng-container matColumnDef="horasAusentismoNoPago">
            <th mat-header-cell *matHeaderCellDef> Horas Ausentismo No Pago </th>
            <td mat-cell *matCellDef="let orden"> {{ orden.horasAusentismoNoPago }} </td> 
          </ng-container> 
  
          <tr mat-header-row *matHeaderRowDef="displayedColumnsObtenerOrdenes"></tr>
    
          <tr mat-row *matRowDef="let row; columns: displayedColumnsObtenerOrdenes;"></tr>
    
          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell" [colSpan]="displayedColumnsObtenerOrdenes.length">
              No se encontraron informes con los filtros seleccionados.
            </td>
          </tr>
        </table>

        <div class="resumen-container" *ngIf="!loading">
          <div class="resumen-grid">
            <div class="resumen-item total-horas">
              <strong>Total Horas Proyectadas:</strong>
              <span>{{ totales.horasProyectadas }}</span>
            </div>
            <div class="resumen-item horas-trabajadas">
              <strong>Total Horas Trabajadas:</strong>
              <span>{{ totales.horasTrabajadas }}</span>
            </div>
            <div class="resumen-item ausentismo-pago">
              <strong>Horas Ausentismo Pago:</strong>
              <span>{{ totales.horasAusentismoPago }}</span>
            </div>
            <div class="resumen-item ausentismo-impago">
              <strong>Horas Ausentismo Impago:</strong>
              <span>{{ totales.horasAusentismoNoPago }}</span>
            </div>
          </div>
        </div>
        <mat-paginator [pageSize]="[5,10,25,100]" aria-label="Seleccionar Pagina de Informes"></mat-paginator>

        <div *ngIf="loading" class="mat-spinner-container">
            <mat-spinner [diameter]="40"></mat-spinner>
        </div>

      </div>
    </div>

    <!-- Tabla Reporte de horas por Dia -->
    <div *ngIf="reporteSeleccionado === 'Reporte de horas por Dia'">

      <div class="table-container mat-elevation-z8"> 
        <table mat-table [dataSource]="dataSource" matSort> 
          <ng-container matColumnDef="empresa">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Empresa </th>
            <td mat-cell *matCellDef="let orden"> {{ orden.ordenTrabajo.servicio.nombre }} </td>
          </ng-container>
  
          <ng-container matColumnDef="empleado">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Empleado </th>
            <td mat-cell *matCellDef="let orden"> {{ orden.empleado?.nombre + ' ' + orden.empleado?.apellido }} </td>
          </ng-container>

          <ng-container matColumnDef="estado">
            <th mat-header-cell *matHeaderCellDef> Estado </th>
            <td mat-cell *matCellDef="let orden"> {{ orden.estado }} </td> 
          </ng-container>

          <ng-container matColumnDef="empleadoSuplente">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Empleado Suplente </th>
            <td mat-cell *matCellDef="let orden"> {{ orden.empleadoSuplente ? (orden.empleadoSuplente.nombre + ' ' + orden.empleadoSuplente.apellido) : '' }}</td>
          </ng-container>

          <ng-container matColumnDef="estadoSuplente">
            <th mat-header-cell *matHeaderCellDef> Estado Suplente </th>
            <td mat-cell *matCellDef="let orden"> {{ orden.estadoSuplente ? orden.estadoSuplente : '' }} </td> 
          </ng-container> 
  
          <ng-container matColumnDef="fecha">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Fecha </th>
            <td mat-cell *matCellDef="let orden"> {{ orden.fecha | date:'yyyy-MM-dd' }} </td>
          </ng-container>
  
          <ng-container matColumnDef="horasInicioProyectado">
            <th mat-header-cell *matHeaderCellDef> Horas Inicio </th>
            <td mat-cell *matCellDef="let orden"> {{ orden.horaInicioProyectado }} </td>
          </ng-container>
  
          <ng-container matColumnDef="horasFinProyectado">
            <th mat-header-cell *matHeaderCellDef> Horas Fin </th>
            <td mat-cell *matCellDef="let orden"> {{ orden.horaFinProyectado }} </td>
          </ng-container>
  
          <ng-container matColumnDef="horaInicioReal">
            <th mat-header-cell *matHeaderCellDef> Hora Inicio R </th>
            <td mat-cell *matCellDef="let orden"> {{ orden.horaInicioReal }} </td>
          </ng-container>
  
          <ng-container matColumnDef="horaFinReal">
            <th mat-header-cell *matHeaderCellDef> Hora Fin R </th>
            <td mat-cell *matCellDef="let orden"> {{ orden.horaFinReal }} </td>
          </ng-container>

          <ng-container matColumnDef="horasTotales">
            <th mat-header-cell *matHeaderCellDef> Horas Totales </th>
            <td mat-cell *matCellDef="let orden"> {{ orden.duracionReal }} </td>
          </ng-container>
  
          <tr mat-header-row *matHeaderRowDef="displayedColumnsHorasPorDia"></tr>
    
          <tr mat-row *matRowDef="let row; columns: displayedColumnsHorasPorDia;"></tr>
    
          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell" [colSpan]="displayedColumnsHorasPorDia.length">
              No se encontraron informes con los filtros seleccionados.
            </td>
          </tr>
        </table>

        <mat-paginator [pageSizeOptions]="[5,10,25,100]" [pageSize]="10" aria-label="Seleccionar Pagina de Informes"></mat-paginator>
  
        <div *ngIf="loading" class="mat-spinner-container">
            <mat-spinner [diameter]="40"></mat-spinner>
        </div>
        
      </div>
      <div *ngIf="!loading && dataSource.data && dataSource.data.length > 0" class="resumen-container">
        <div class="resumen-grid">
          <div class="resumen-item total-horas">
            <strong>Horas Proyectadas:</strong> 
            <span> {{ totalHorasProyectadasGlobal | number:'1.2-2' }} </span>
          </div>
          <div class="resumen-item horas-trabajadas">
            <strong>Horas Reales:</strong> 
            <span>{{ totalHorasRealesGlobal | number:'1.2-2' }}</span>
          </div>
        </div>
      </div>
    </div>

     <!-- Tabla Reporte Mensual Empleado -->
    <div *ngIf="reporteSeleccionado === 'Informe mensual empleado'">
      <div class="table-container mat-elevation-z8">
        <table mat-table [dataSource]="dataSource" matSort class="tabla-horarios-detallada">
          
          <!-- Columna Día -->
          <ng-container matColumnDef="dia">
            <th mat-header-cell *matHeaderCellDef class="header-dia">Día</th>
            <td mat-cell *matCellDef="let dia" class="cell-dia">{{ dia.displayName }}</td>
          </ng-container>

          <!-- Columna Horas Categoría -->
          <ng-container matColumnDef="horasCategoria">
            <th mat-header-cell *matHeaderCellDef class="header-horas">H. Categoría</th>
            <td mat-cell *matCellDef="let dia" class="cell-horas">
              {{ dia.horasCategoria | number: '1.2-2' }}
            </td>
          </ng-container>

          <!-- Columnas dinámicas para servicios -->
          <ng-container *ngFor="let servicio of servicios" [matColumnDef]="getServicioColumnName(servicio)">
            <th mat-header-cell *matHeaderCellDef class="header-servicio">
              {{ getServicioNombreCorto(servicio) }}
            </th>
            <td mat-cell *matCellDef="let dia" class="cell-servicio">
              {{ (dia.horasPorServicio[servicio] || 0) | number: '1.2-2' }}
            </td>
          </ng-container>

          <!-- Fila de encabezados -->
          <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>

          <!-- Filas de datos -->
          <tr mat-row *matRowDef="let row; columns: displayedColumns;" 
              [class.fila-con-datos]="row.horasCategoria > 0"></tr>

          <!-- Mensaje cuando no hay datos -->
          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell" [colSpan]="displayedColumns.length">
              No se encontraron datos para el período seleccionado.
            </td>
          </tr>
        </table>

        <!-- Fila de totales (fuera de la tabla para que sea más visible) -->
        <div class="totales-container" *ngIf="!loading">
          <h3>Totales por Servicio</h3>
          <div class="totales-grid">
            <div class="total-item" *ngFor="let servicio of servicios">
              <strong>{{ servicio }}:</strong>
              <span>{{ getTotalPorServicio(servicio) | number: '1.2-2' }}</span>
            </div>
          </div>
        </div>

        <!-- Resumen final -->
        <div class="resumen-container" *ngIf="!loading">
          <h3>Resumen Final</h3>
          <div class="resumen-grid">
            <div class="resumen-item ausentismo-pago">
              <strong>Horas Ausentismo Pago:</strong>
              <span>{{ horasAusentismoPago | number: '1.2-2' }}</span>
            </div>
            <div class="resumen-item ausentismo-impago">
              <strong>Horas Ausentismo Impago:</strong>
              <span>{{ horasAusentismoImpago | number: '1.2-2' }}</span>
            </div>
            <div class="resumen-item horas-trabajadas">
              <strong>Total Horas Trabajadas:</strong>
              <span>{{ horasTrabajadas | number: '1.2-2' }}</span>
            </div>
            <div class="resumen-item total-horas">
              <strong>Total Horas:</strong>
              <span>{{ totalHoras | number: '1.2-2' }}</span>
            </div>
            <div class="resumen-item total-horas">
              <strong>Horas Categoria:</strong>
              <span>{{ horasCategoria | number: '1.2-2' }}</span>
            </div>
          </div>

          <!-- Horas discriminadas -->
          <div class="discriminadas-container" *ngIf="horasDiscriminadas && getObjectKeys(horasDiscriminadas).length > 0">
            <h3>Horas Discriminadas</h3>
            <div class="discriminadas-grid">
              <div class="discriminada-item" *ngFor="let estado of getObjectKeys(horasDiscriminadas)">
                <strong>{{ estado | titlecase }}:</strong>
                <span>{{ horasDiscriminadas[estado] | number: '1.2-2' }}</span>
              </div>
            </div>
          </div>
        </div>

        <mat-paginator [pageSizeOptions]="[31, 50, 100]" [pageSize]="31" aria-label="Seleccionar Página"></mat-paginator>

        <div *ngIf="loading" class="mat-spinner-container">
          <mat-spinner [diameter]="40"></mat-spinner>
        </div>
      </div>
    </div> 
  </div>
</div>
